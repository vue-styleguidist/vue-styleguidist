version: 2

defaults: &defaults
  docker:
    - image: circleci/node:latest-browsers
  working_directory: ~/vue-styleguidist

jobs:
  install:
    <<: *defaults

    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-vue-styleguidist-{{ checksum "yarn.lock" }}
      - run: yarn
      - save_cache:
          key: v1-vue-styleguidist-{{ checksum "yarn.lock" }}
          paths:
            - node_modules/
      - persist_to_workspace:
          root: ~/
          paths:
            - vue-styleguidist

  compile:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/
      - run: yarn compile
      - persist_to_workspace:
          root: ~/
          paths:
            - vue-styleguidist

  unit_test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/

      # remake the yarn link
      - run: yarn install
      - run: yarn lint
      - run: yarn test

  examples-basic:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/

      # Build all examples
      - run: yarn build basic
      - run: yarn build customised
      - run: yarn build sections
      - run: yarn build vuex

      # Check that examples really works: no JS errors on load
      - run: yarn test:browser basic
      - run: yarn test:browser customised
      - run: yarn test:browser sections
      - run: yarn test:browser vuex

  examples-vuecli:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/

      # remake the yarn link to vue-cli-plugin
      - run: yarn install
      - run: yarn build:vuecli3
      - run: yarn build vuecli-noplugin
      - run: yarn test:browser vuecli3
      - run: yarn test:browser vuecli-noplugin

  examples-other:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/

      # Build all examples
      - run: yarn build jsx
      - run: yarn build nuxtjs/styleguide
      - run: yarn build vuetify

      # Check that examples really works: no JS errors on load
      - run: yarn test:browser jsx
      - run: yarn test:browser nuxtjs
      - run: yarn test:browser vuetify

  publish:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/

      - run: yarn install
      - run: git config --global user.name "Vue Styleguidist Bot"
      - run: git config --global user.email "cluedude@hotmail.com"
      - run: git remote set-url origin "https://${GH_TOKEN}@github.com/vue-styleguidist/vue-styleguidist.git" > /dev/null 2>&1
      - run: git checkout master
      - run: git reset --hard
      - run: echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" >> $HOME/.npmrc 2> /dev/null
      - run: yarn lerna version --yes --github-release
      - run: yarn lerna publish from-git --yes

workflows:
  version: 2
  test:
    jobs:
      - install
      - compile:
          requires:
            - install
      - unit_test:
          requires:
            - compile
      - examples-basic:
          requires:
            - compile
      - examples-vuecli:
          requires:
            - compile
      - examples-other:
          requires:
            - compile
      - publish:
          requires:
            - unit_test
            - examples-basic
            - examples-vuecli
            - examples-other
          filters:
            branches:
              only:
                - master
