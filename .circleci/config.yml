version: 2.1

defaults: &defaults
  docker:
    - image: cypress/included:cypress-13.12.0-node-20.14.0-chrome-126.0.6478.114-1-ff-127.0.1-edge-126.0.2592.61-1
      environment:
        NODE_OPTIONS: '--openssl-legacy-provider'
  working_directory: ~/vue-styleguidist

jobs:
  examples-basic:
    <<: *defaults
    steps:
      - checkout

      - run:
          name: Install pnpm package manager
          command: |
            corepack enable
            corepack prepare pnpm@latest-9 --activate
            pnpm config set store-dir .pnpm-store

      - run:
          name: Install Dependencies
          command: |
            pnpm install

      - run: npx puppeteer browsers install chrome

      # Build all examples
      - run: npm run build basic -- --ci
      - run: npm run build customised -- --ci
      - run: npm run build sections -- --ci
      - run: npm run build vuex -- --ci
      - run: npm run build functional-flag -- --ci

      # Check that examples really works: no JS errors on load
      - run: npm run test:browser basic
      - run: npm run test:browser customised
      - run: npm run test:browser sections
      - run: npm run test:browser vuex
      - run: npm run test:browser functional-flag

  examples-vuecli:
    <<: *defaults
    steps:
      - checkout

      - run:
          name: Install pnpm package manager
          command: |
            corepack enable
            corepack prepare pnpm@latest-9 --activate
            pnpm config set store-dir .pnpm-store

      - run:
          name: Install Dependencies
          command: |
            pnpm install

      - run: npx puppeteer browsers install chrome

      # remake the pnpm link to vue-cli-plugin
      - run: pnpm build vuecli3 -- --ci
      - run: pnpm test:browser vuecli3
      # - run: pnpm build vuecli-noplugin -- --ci
      # - run: pnpm test:browser vuecli-noplugin
      - run: pnpm build vuecli3-vuetify-ie -- --ci
      - run: pnpm test:browser vuecli3-vuetify-ie

  examples-other:
    <<: *defaults
    steps:
      - checkout

      - run:
          name: Install pnpm package manager
          command: |
            corepack enable
            corepack prepare pnpm@latest-8 --activate
            pnpm config set store-dir .pnpm-store

      - run:
          name: Install Dependencies
          command: |
            pnpm install --ignore-scripts

      - run:
          name: Compile vue-docgen-api
          command: |
            pnpm compile --filter=vue-docgen-api

      - run:
          name: Compile Packages
          command: |
            pnpm compile

      - run: npx puppeteer browsers install chrome

      # Build all examples
      - run: pnpm build jsx -- --ci
      - run: pnpm build jsx-examples -- --ci
      - run: pnpm build nuxtjs -- --ci
      - run: pnpm build vuetify -- --ci
      - run: pnpm build docgen-vite

      # Check that examples really works: no JS errors on load
      - run: pnpm test:browser jsx
      - run: pnpm test:browser jsx-examples
      - run: pnpm test:browser nuxtjs
      - run: pnpm test:browser vuetify
      - run: pnpm test:browser docgen-vite

  cypress:
    <<: *defaults
    steps:
      - checkout

      - run:
          name: Set Cypress record key
          # CircleCi does not allow interpolation in the environment field
          # we have to set the key using a command
          command: |
            echo 'export CYPRESS_RECORD_KEY=$MAIN_RECORD_KEY' >> "$BASH_ENV"

      - run:
          name: Install pnpm package manager
          command: |
            corepack enable
            corepack prepare pnpm@latest-9 --activate
            pnpm config set store-dir .pnpm-store

      - run:
          name: Install Dependencies
          command: |
            pnpm install --ignore-scripts

      - run:
          name: Compile vue-docgen-api
          command: |
            pnpm compile --filter=vue-docgen-api

      - run:
          name: Compile Packages
          command: |
            pnpm compile

      # run cypress vue-styleguidist component tests
      - run:
          command: pnpm exec cypress run --component --record --group ct
          working_directory: packages/vue-styleguidist

      # run cypress prismjs-highlighter component tests
      - run:
          command: pnpm exec cypress run --component --record --group ct-prismjs
          working_directory: packages/vue-inbrowser-prismjs-highlighter

      # run cypress e2e tests
      - run:
          command: pnpm exec start-server-and-test cy:serve http://localhost:6060 "cypress run --e2e --spec \"test/cypress/integration/basic/*.*\" --record --group main"
          environment:
            CY_EXAMPLE_FOLDER: basic
      - store_artifacts:
          path: /root/vue-styleguidist/test/cypress/screenshots
          destination: cy-screenshots-basic

      - run:
          command: pnpm exec start-server-and-test cy:serve http://localhost:6060 "cypress run --spec \"test/cypress/integration/jsx-examples/*.*\"  --e2e --record --group jsx"
          environment:
            CY_EXAMPLE_FOLDER: jsx-examples
      - store_artifacts:
          path: /root/vue-styleguidist/test/cypress/screenshots
          destination: cy-screenshots-jsx

      # run cypress component tests vue3
      - run:
          name: Run Vue 3 component tests for vue-styleguidist
          command: pnpm install:vue3 && pnpm exec cypress run --component --record --group ct-vue3 --config-file packages/vue-styleguidist/cypress.config.vue3.ts

      # run cypress component tests vue3
      - run:
          name: Run Vue 3 component tests for prismjs highlighter
          command: pnpm exec cypress run --component --record --group ct-prismjs-vue3 --config-file packages/vue-inbrowser-prismjs-highlighter/cypress.config.vue3.ts

workflows:
  test:
    jobs:
      - examples-basic
      - examples-vuecli
      - examples-other
      - cypress
# VS Code Extension Version: 1.5.1
